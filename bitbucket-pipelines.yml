# This is a sample build configuration for Other.
# Check our guides at https://confluence.atlassian.com/x/5Q4SMw for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
# image: atlassian/default-image:latest

image: microsoft/dotnet:1.1-sdk
pipelines:
  tags:
    - step:
        script:
          - apt-get update
          - apt-get install -y nodejs npm
          - npm i bower --global
          - export PATH=$PATH:./node_modules/.bin
          - export CHATAPP_DATAPROVIDER=Postgres
          - export CHATAPP_CONNECTSTRING='Host=localhost; User ID=ChatApp; Password=Password; Port=5432; Database=ChatApp; Pooling=true;'
          - dotnet restore
          - cd ./src/ChatApp
          - rm -f ./Migrations/*.cs
          - dotnet ef migrations add Init
          - dotnet ef database update
          - dotnet build
        services:
          - postgres

definitions:
  services:
    postgres:
      image: postgres
      environment:
        POSTGRES_DB: 'postgres'
        POSTGRES_USER: 'ChatApp'
        POSTGRES_PASSWORD: 'Password'
